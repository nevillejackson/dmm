%
% Draft  document dmmClassSpecific.tex
% Notes on Estimating class-specific genetic parameters
%
 
\documentclass[titlepage]{article}  % Latex2e
\usepackage{graphicx,lscape,subfigure}
\usepackage{bm}
\usepackage{textcomp}
 

\title{ Estimating class-specific genetic parameters with {\em dmm()}}
\author{Neville Jackson }
\date{2 June 2020 \\
      For dmm\_2.1-6}   % Deleting this command produces today's date.

 
\begin{document} 
 
\maketitle      
\tableofcontents

\section{Introduction} 
The function {\em dmm()} sets up equations which relate the observed covariance of pairs of individuals or dyads, to their expectation in terms of postulated genetic and environmental variance and covariance components.  These equations, termed dyadic model equations (DME's), can be solved directly to obtain estimates of variance and covariance components.  

In versions of {\em dmm()} prior to dmm\_2.1-1 the various genetic and environmental variance/covariance components could only be estimated each as a single component applying to the whole population represented by the data. Each component mapped to one column of the $\boldmath W$ matrix which contains the coefficients of the dyadic model equations.

From version dmm\_2.1-1, components can be estimated separately for each class of a specific effect which is coded as a factor in the dataframe. Such components are termed {\em class specific components}. Each class specific component occupies two or more columns of the $\boldmath W$ matrix, depending on the number of classes in the specific effect, and results in two or more component estimates.

This document deals with how to use {\em dmm()} to obtain class specific component estimates, and with how the class specific components translate into genetic parameters and estimates of genetic change.


 
\section{Getting started with class specific component estimates}
\label{sec:getstart}
 We assume that the reader is already familiar with use of {\em dmm()}. If not consult the document {\em dmmOverview.pdf}~\cite{jack:15}, and get some practice with the usual nonspecific component estimates before attempting a class-specific case.

 We shall use the small demonstration dataset {\em sheep.df}. This has three traits, and three fixed effect factors called "Sex", "Year", and "Tb". "Year" is year of birth for each animal, and "Tb" stands for "type of birth" which is coded as "S" for single born animals, and "T" for twins.  Prepare the data ass follows:
\begin{verbatim}
> library(dmm)
> data(sheep.df)
> sheep.mdf <- mdf(sheep.df,pedcols=c(1:3),factorcols=c(4:6),ycols=c(7:9),
     sexcode=c("M","F"),relmat=c("E","A"))
\end{verbatim}

\subsection{Parameters specific to one factor}

 Assume that we  wish to estimate additive genetic variance "VarG(Ia)" separately for each Sex. This is possible even though each individual can only be of one Sex, because the additive genetic relationship matrix  allows the model fitting to exploit genetic relationships between animals of like and unlike Sex. 
The same is not possible for the individual environmental variance component "VarE(I)". It can only be estimated ignoring Sex. So we leave "VarE(I)" as a "components" argument and put "VarG(Ia)" as a "specific.components" argument in the call to {\em dmm()}, as follows

\begin{verbatim}
> sheep.fitss <- dmm(sheep.mdf, Ymat ~ 1 + Year + Sex,
   components=c("VarE(I)"),
   specific.components=list(Sex=c("VarG(Ia)")))
Dyadic mixed model fit for datafile: sheep.mdf  
Data file is a normal dataframe:
Random effect partitioned into components: Residual:
OLS-b step:
no of fixed effect df (k) =  9 
no of traits (l) =  3 
Setup antemodel matrices:
No of factors with specific components: 1 
No of non-specific components partitioned: 1 
No of factors with specific components: 1 
No of specific variance components partitioned (per component): 2 
No of specific variance and covariance components partitioned (per component): 4 
no of individuals in pedigree (m) =  44 
no of individuals with data and X codes (n) =  37 
Rank of X: 9   No of Fixed Effects: 9 
DME substep:
No of components defined =  5 
No of components estimable =  5 
Checking dyadic model equations:
QR option on dyadic model equations:
DME substep completed:
OLS-b step completed:
> 
\end{verbatim}
So we see a bit more output tabbing than with a normal (non-specific) dmm run. It is simply letting us know that it has been given one factor called Sex which has specific component(s), that there is one non-specific component, and one specific component, that the specific classes are "Sex:M" and "Sex:F", and that it will make 4 classes of component called "Sex:F:F", "Sex:F:M", "Sex:M:F", and  "Sex:M:M". The first and last of these 4 classes will contain variance component  estimates for each Sex, and the second and third of these 4 classes will contain cross-sex covariance component estimates.

If that seems complex, it will become clear as we view the results. We first look at the component estimates exactly as fitted, using the {\em summary()} function.
\begin{verbatim}
> summary(sheep.fitss,traitset=c("Cww","Diam")
+ )
Call:
summary.dmm(object = sheep.fitss, traitset = c("Cww", "Diam"))

Coefficients fitted by OLS for fixed effects:

            Trait Estimate StdErr   CI95lo CI95hi
(Intercept)   Cww   4.1000  0.267  3.57615  4.624
Year1982      Cww   0.7667  0.378  0.02583  1.508
Year1983      Cww   0.0441  0.356 -0.65442  0.743
Year1984      Cww   0.3881  0.339 -0.27687  1.053
Year1985      Cww   0.6361  0.323  0.00203  1.270
Year1986      Cww   0.9470  0.328  0.30315  1.591
Year1987      Cww   0.4588  0.333 -0.19334  1.111
Year1988      Cww  -0.2237  0.564 -1.32829  0.881
SexM          Cww   0.2237  0.178 -0.12614  0.574

            Trait Estimate StdErr CI95lo CI95hi
(Intercept)  Diam  20.5667  0.565 19.459 21.674
Year1982     Diam   0.7333  0.799 -0.833  2.299
Year1983     Diam  -0.3978  0.753 -1.874  1.079
Year1984     Diam  -0.4623  0.717 -1.868  0.943
Year1985     Diam  -0.0308  0.684 -1.371  1.309
Year1986     Diam   0.9085  0.694 -0.452  2.269
Year1987     Diam   0.2085  0.703 -1.170  1.587
Year1988     Diam  -1.6913  1.191 -4.026  0.644
SexM         Diam   0.2246  0.377 -0.515  0.964


Components partitioned by DME from residual var/covariance after OLS-b fit:

                 Traitpair Estimate StdErr   CI95lo CI95hi
VarE(I)            Cww:Cww    0.107 0.0596 -0.01012  0.224
Sex:F:F:VarG(Ia)   Cww:Cww    0.119 0.0564  0.00872  0.230
Sex:F:M:VarG(Ia)   Cww:Cww    0.199 0.0821  0.03804  0.360
Sex:M:F:VarG(Ia)   Cww:Cww    0.199 0.0821  0.03804  0.360
Sex:M:M:VarG(Ia)   Cww:Cww    0.332 0.0778  0.17986  0.485

                 Traitpair Estimate StdErr  CI95lo CI95hi
VarE(I)           Cww:Diam   0.0276  0.128 -0.2233  0.279
Sex:F:F:VarG(Ia)  Cww:Diam   0.2244  0.121 -0.0127  0.462
Sex:F:M:VarG(Ia)  Cww:Diam   0.4124  0.176  0.0668  0.758
Sex:M:F:VarG(Ia)  Cww:Diam   0.3711  0.176  0.0254  0.717
Sex:M:M:VarG(Ia)  Cww:Diam   0.5040  0.167  0.1765  0.832

                 Traitpair Estimate StdErr  CI95lo CI95hi
VarE(I)           Diam:Cww   0.0276  0.128 -0.2233  0.279
Sex:F:F:VarG(Ia)  Diam:Cww   0.2244  0.121 -0.0127  0.462
Sex:F:M:VarG(Ia)  Diam:Cww   0.3711  0.176  0.0254  0.717
Sex:M:F:VarG(Ia)  Diam:Cww   0.4124  0.176  0.0668  0.758
Sex:M:M:VarG(Ia)  Diam:Cww   0.5040  0.167  0.1765  0.832

                 Traitpair Estimate StdErr CI95lo CI95hi
VarE(I)          Diam:Diam   0.0585  0.268 -0.467  0.584
Sex:F:F:VarG(Ia) Diam:Diam   0.8586  0.254  0.362  1.356
Sex:F:M:VarG(Ia) Diam:Diam   0.5472  0.370 -0.177  1.271
Sex:M:F:VarG(Ia) Diam:Diam   0.5472  0.370 -0.177  1.271
Sex:M:M:VarG(Ia) Diam:Diam   1.4274  0.350  0.741  2.114

> 
\end{verbatim}
 We see that component "VarG(Ia)" is estimated for all 4 classes simultneously, and there is just one overall estimate for "VarE(I)". The columns of these tables do not sum to phenotypic variance "VarP(I)", as they would for a nonspecific case. To get the components summing properly to "VarP(I)" we need to reorganize the summary listing into classes. This is done with the new function {\em csummary()} as follows
\begin{verbatim}
> csummary(sheep.fitss,traitset=c("Cww","Diam"))
Call:
csummary.specific(object = object, traitset = traitset, componentset = componentset, 
    bytrait = bytrait, gls = gls, digits = digits)

Components partitioned by DME from residual var/covariance after OLS-b fit:


Specific class:  Sex:F:F 
         Traitpair Estimate StdErr   CI95lo CI95hi
VarE(I)    Cww:Cww    0.107 0.0596 -0.01012  0.224
VarG(Ia)   Cww:Cww    0.119 0.0564  0.00872  0.230
VarP(I)    Cww:Cww    0.226 0.0359  0.15552  0.296

         Traitpair Estimate StdErr  CI95lo CI95hi
VarE(I)   Cww:Diam   0.0276 0.1280 -0.2233  0.279
VarG(Ia)  Cww:Diam   0.2244 0.1210 -0.0127  0.462
VarP(I)   Cww:Diam   0.2521 0.0771  0.1009  0.403

         Traitpair Estimate StdErr  CI95lo CI95hi
VarE(I)   Diam:Cww   0.0276 0.1280 -0.2233  0.279
VarG(Ia)  Diam:Cww   0.2244 0.1210 -0.0127  0.462
VarP(I)   Diam:Cww   0.2521 0.0771  0.1009  0.403

         Traitpair Estimate StdErr CI95lo CI95hi
VarE(I)  Diam:Diam   0.0585  0.268 -0.467  0.584
VarG(Ia) Diam:Diam   0.8586  0.254  0.362  1.356
VarP(I)  Diam:Diam   0.9171  0.162  0.600  1.234



Specific class:  Sex:F:M 
         Traitpair Estimate StdErr CI95lo CI95hi
VarE(I)    Cww:Cww       NA     NA     NA     NA
VarG(Ia)   Cww:Cww    0.199 0.0821  0.038   0.36
VarP(I)    Cww:Cww       NA     NA     NA     NA

         Traitpair Estimate StdErr CI95lo CI95hi
VarE(I)   Cww:Diam       NA     NA     NA     NA
VarG(Ia)  Cww:Diam    0.412  0.176 0.0668  0.758
VarP(I)   Cww:Diam       NA     NA     NA     NA

         Traitpair Estimate StdErr CI95lo CI95hi
VarE(I)   Diam:Cww       NA     NA     NA     NA
VarG(Ia)  Diam:Cww    0.371  0.176 0.0254  0.717
VarP(I)   Diam:Cww       NA     NA     NA     NA

         Traitpair Estimate StdErr CI95lo CI95hi
VarE(I)  Diam:Diam       NA     NA     NA     NA
VarG(Ia) Diam:Diam    0.547   0.37 -0.177   1.27
VarP(I)  Diam:Diam       NA     NA     NA     NA



Specific class:  Sex:M:F 
         Traitpair Estimate StdErr CI95lo CI95hi
VarE(I)    Cww:Cww       NA     NA     NA     NA
VarG(Ia)   Cww:Cww    0.199 0.0821  0.038   0.36
VarP(I)    Cww:Cww       NA     NA     NA     NA

         Traitpair Estimate StdErr CI95lo CI95hi
VarE(I)   Cww:Diam       NA     NA     NA     NA
VarG(Ia)  Cww:Diam    0.371  0.176 0.0254  0.717
VarP(I)   Cww:Diam       NA     NA     NA     NA

         Traitpair Estimate StdErr CI95lo CI95hi
VarE(I)   Diam:Cww       NA     NA     NA     NA
VarG(Ia)  Diam:Cww    0.412  0.176 0.0668  0.758
VarP(I)   Diam:Cww       NA     NA     NA     NA

         Traitpair Estimate StdErr CI95lo CI95hi
VarE(I)  Diam:Diam       NA     NA     NA     NA
VarG(Ia) Diam:Diam    0.547   0.37 -0.177   1.27
VarP(I)  Diam:Diam       NA     NA     NA     NA



Specific class:  Sex:M:M 
         Traitpair Estimate StdErr  CI95lo CI95hi
VarE(I)    Cww:Cww    0.107 0.0596 -0.0101  0.224
VarG(Ia)   Cww:Cww    0.332 0.0778  0.1799  0.485
VarP(I)    Cww:Cww    0.439 0.0560  0.3294  0.549

         Traitpair Estimate StdErr CI95lo CI95hi
VarE(I)   Cww:Diam   0.0276  0.128 -0.223  0.279
VarG(Ia)  Cww:Diam   0.5040  0.167  0.177  0.832
VarP(I)   Cww:Diam   0.5317  0.120  0.296  0.767

         Traitpair Estimate StdErr CI95lo CI95hi
VarE(I)   Diam:Cww   0.0276  0.128 -0.223  0.279
VarG(Ia)  Diam:Cww   0.5040  0.167  0.177  0.832
VarP(I)   Diam:Cww   0.5317  0.120  0.296  0.767

         Traitpair Estimate StdErr CI95lo CI95hi
VarE(I)  Diam:Diam   0.0585  0.268 -0.467  0.584
VarG(Ia) Diam:Diam   1.4274  0.350  0.741  2.114
VarP(I)  Diam:Diam   1.4859  0.252  0.992  1.980


> 
\end{verbatim} 
 So now we have 4 separate variance component summary tables. The first and last ( called Sex:F:F and Sex:M:M) are the variance components for each Sex level, and "VarE(I)" is listed there because it is assumed that the overall estimate of "VarE(I)" applies to each Sex level. Because "VarE(I)" is estimable, we are able to calculate "VarP(I)" for these two Sex levels. 

The second and third tables ( called Sex:F:M and Sex:M:F) are the cross-sex component estimates. It can be seen that only "VarG(Ia)" is estimable as a cross-sex parameter. "VarE(I)" and "VarP(I)" are marked 'NA' to make clear that they are not estimable for the cross-sex cases. Note that we retain the two symmetric cross-sex cases (F:M and M:F) because for the cross-sex-cross-trait cases they are not the same.

The variance components are now grouped in a way suitable for estimation of genetic parameters, so if we use the {\em gsummary()} function we get the same 4 groupings, but converted to heritabilities and genetic correlations, as follows:

\begin{verbatim}
> gsummary(sheep.fitss,traitset=c("Cww","Diam"))
Call:
gsummary.specific(dmmobj = dmmobj, traitset = traitset, componentset = componentset, 
    bytrait = bytrait, gls = gls, digits = digits)

Components partitioned by DME from residual var/covariance after OLS-b fit:


Specific class:  Sex:F:F 
Proportion of phenotypic var/covariance to each component:
         Trait Estimate StdErr  CI95lo CI95hi
VarE(I)    Cww    0.473  0.239 0.00337  0.942
VarG(Ia)   Cww    0.527  0.244 0.05016  1.005
VarP(I)    Cww    1.000  0.000 1.00000  1.000

         Trait Estimate StdErr CI95lo CI95hi
VarE(I)   Diam   0.0638  0.222 -0.372  0.499
VarG(Ia)  Diam   0.9362  0.289  0.370  1.502
VarP(I)   Diam   1.0000  0.000  1.000  1.000

Correlation corresponding to each var/covariance component:
         Traitpair Estimate StdErr CI95lo CI95hi
VarE(I)    Cww:Cww        1      0      1      1
VarG(Ia)   Cww:Cww        1      0      1      1
VarP(I)    Cww:Cww        1      0      1      1

         Traitpair Estimate StdErr CI95lo CI95hi
VarE(I)   Cww:Diam    0.350  0.288 -0.214  0.913
VarG(Ia)  Cww:Diam    0.702  0.205  0.300  1.103
VarP(I)   Cww:Diam    0.554  0.108  0.342  0.765

         Traitpair Estimate StdErr CI95lo CI95hi
VarE(I)   Diam:Cww    0.350  0.288 -0.214  0.913
VarG(Ia)  Diam:Cww    0.702  0.205  0.300  1.103
VarP(I)   Diam:Cww    0.554  0.108  0.342  0.765

         Traitpair Estimate StdErr CI95lo CI95hi
VarE(I)  Diam:Diam        1      1  -0.96   2.96
VarG(Ia) Diam:Diam        1      0   1.00   1.00
VarP(I)  Diam:Diam        1      0   1.00   1.00

Phenotypic var/covariance from summing components:
  Traitpair Estimate StdErr CI95lo CI95hi
1   Cww:Cww    0.226 0.0359  0.156  0.296
2  Cww:Diam    0.252 0.0771  0.101  0.403
3  Diam:Cww    0.252 0.0771  0.101  0.403
4 Diam:Diam    0.917 0.1616  0.600  1.234



Specific class:  Sex:F:M 
Proportion of phenotypic var/covariance to each component:
         Trait Estimate StdErr CI95lo CI95hi
VarE(I)    Cww       NA     NA     NA     NA
VarG(Ia)   Cww       NA     NA     NA     NA
VarP(I)    Cww       NA      0     NA     NA

         Trait Estimate StdErr CI95lo CI95hi
VarE(I)   Diam       NA     NA     NA     NA
VarG(Ia)  Diam       NA     NA     NA     NA
VarP(I)   Diam       NA      0     NA     NA

Correlation corresponding to each var/covariance component:
         Traitpair Estimate StdErr CI95lo CI95hi
VarE(I)    Cww:Cww        1     NA     NA     NA
VarG(Ia)   Cww:Cww        1      0      1      1
VarP(I)    Cww:Cww        1     NA     NA     NA

         Traitpair Estimate StdErr CI95lo CI95hi
VarE(I)   Cww:Diam       NA     NA     NA     NA
VarG(Ia)  Cww:Diam        1  0.243  0.524   1.48
VarP(I)   Cww:Diam       NA     NA     NA     NA

         Traitpair Estimate StdErr CI95lo CI95hi
VarE(I)   Diam:Cww       NA     NA     NA     NA
VarG(Ia)  Diam:Cww    0.695  0.175  0.352   1.04
VarP(I)   Diam:Cww       NA     NA     NA     NA

         Traitpair Estimate StdErr CI95lo CI95hi
VarE(I)  Diam:Diam    1.000     NA     NA     NA
VarG(Ia) Diam:Diam    0.494      0  0.494  0.494
VarP(I)  Diam:Diam    1.000     NA     NA     NA

Phenotypic var/covariance from summing components:
  Traitpair Estimate StdErr CI95lo CI95hi
1   Cww:Cww       NA     NA     NA     NA
2  Cww:Diam       NA     NA     NA     NA
3  Diam:Cww       NA     NA     NA     NA
4 Diam:Diam       NA     NA     NA     NA



Specific class:  Sex:M:F 
Proportion of phenotypic var/covariance to each component:
         Trait Estimate StdErr CI95lo CI95hi
VarE(I)    Cww       NA     NA     NA     NA
VarG(Ia)   Cww       NA     NA     NA     NA
VarP(I)    Cww       NA      0     NA     NA

         Trait Estimate StdErr CI95lo CI95hi
VarE(I)   Diam       NA     NA     NA     NA
VarG(Ia)  Diam       NA     NA     NA     NA
VarP(I)   Diam       NA      0     NA     NA

Correlation corresponding to each var/covariance component:
         Traitpair Estimate StdErr CI95lo CI95hi
VarE(I)    Cww:Cww        1     NA     NA     NA
VarG(Ia)   Cww:Cww        1      0      1      1
VarP(I)    Cww:Cww        1     NA     NA     NA

         Traitpair Estimate StdErr CI95lo CI95hi
VarE(I)   Cww:Diam       NA     NA     NA     NA
VarG(Ia)  Cww:Diam    0.695  0.175  0.352   1.04
VarP(I)   Cww:Diam       NA     NA     NA     NA

         Traitpair Estimate StdErr CI95lo CI95hi
VarE(I)   Diam:Cww       NA     NA     NA     NA
VarG(Ia)  Diam:Cww        1  0.243  0.524   1.48
VarP(I)   Diam:Cww       NA     NA     NA     NA

         Traitpair Estimate StdErr CI95lo CI95hi
VarE(I)  Diam:Diam    1.000     NA     NA     NA
VarG(Ia) Diam:Diam    0.494      0  0.494  0.494
VarP(I)  Diam:Diam    1.000     NA     NA     NA

Phenotypic var/covariance from summing components:
  Traitpair Estimate StdErr CI95lo CI95hi
1   Cww:Cww       NA     NA     NA     NA
2  Cww:Diam       NA     NA     NA     NA
3  Diam:Cww       NA     NA     NA     NA
4 Diam:Diam       NA     NA     NA     NA



Specific class:  Sex:M:M 
Proportion of phenotypic var/covariance to each component:
         Trait Estimate StdErr  CI95lo CI95hi
VarE(I)    Cww    0.243  0.137 -0.0245  0.511
VarG(Ia)   Cww    0.757  0.135  0.4926  1.021
VarP(I)    Cww    1.000  0.000  1.0000  1.000

         Trait Estimate StdErr CI95lo CI95hi
VarE(I)   Diam   0.0394  0.170 -0.294  0.373
VarG(Ia)  Diam   0.9606  0.178  0.612  1.309
VarP(I)   Diam   1.0000  0.000  1.000  1.000

Correlation corresponding to each var/covariance component:
         Traitpair Estimate StdErr CI95lo CI95hi
VarE(I)    Cww:Cww        1      0      1      1
VarG(Ia)   Cww:Cww        1      0      1      1
VarP(I)    Cww:Cww        1      0      1      1

         Traitpair Estimate StdErr CI95lo CI95hi
VarE(I)   Cww:Diam    0.350 0.2876 -0.214  0.913
VarG(Ia)  Cww:Diam    0.732 0.1372  0.463  1.001
VarP(I)   Cww:Diam    0.658 0.0894  0.483  0.833

         Traitpair Estimate StdErr CI95lo CI95hi
VarE(I)   Diam:Cww    0.350 0.2876 -0.214  0.913
VarG(Ia)  Diam:Cww    0.732 0.1372  0.463  1.001
VarP(I)   Diam:Cww    0.658 0.0894  0.483  0.833

         Traitpair Estimate StdErr CI95lo CI95hi
VarE(I)  Diam:Diam        1      1  -0.96   2.96
VarG(Ia) Diam:Diam        1      0   1.00   1.00
VarP(I)  Diam:Diam        1      0   1.00   1.00

Phenotypic var/covariance from summing components:
  Traitpair Estimate StdErr CI95lo CI95hi
1   Cww:Cww    0.439  0.056  0.329  0.549
2  Cww:Diam    0.532  0.120  0.296  0.767
3  Diam:Cww    0.532  0.120  0.296  0.767
4 Diam:Diam    1.486  0.252  0.992  1.980


> 
\end{verbatim}
Again we get 4 separate sets of {\em gsummary()} tables.
The first and last ( called Sex:F:F and Sex:M:M) provide the sex-specific heritability estimates and genetic correlations. The environmental correlations are the same for both these Sex classes. The phenotypic correlations are not the same, as they are sex-specific too.

The second and third tables (called Sex:F:M and Sex:M:F) provide estimates of the cross-sex genetic correlations and everything else is 'NA'. Note that there are cross-sex-within-trait genetic correlations and cross-sex-cross-trait genetic correlations.

That is as far as we can go. We cannot use these sex-specific parameters to do predictions of genetic change under selection, at the moment, because in {\em dmm} version 2.1-2 the {\em gresponse} function cannot handle class-specific parameters. This will be available in future releases.

\subsection{Parameters specific to more than one factor}

Assume that we now wish to extend the analysis of the sheep.df data , fitting 3 variance components "VarE(I)", "VarG(Ia)", and "VarG(Ma)". We will make "VarG(Ia)" sex-specific, as above, and we will make "VarG(Ma)" tb-specific. "Tb" stands for 'type of birth' and is a factor with 2 levels, "S" for single born lambs, and "T" for twin born lambs. The call to {\em dmm()} is as follows

\begin{verbatim}
> sheep.fitssts <- dmm(sheep.mdf,Ymat ~ 1 + Tb,
   components="VarE(I)",
   specific.components=list(Sex=c("VarG(Ia)"),Tb=c("VarG(Ma)")))
Dyadic mixed model fit for datafile: sheep.mdf  
Data file is a normal dataframe:
Random effect partitioned into components: Residual:
OLS-b step:
no of fixed effect df (k) =  2 
no of traits (l) =  3 
Setup antemodel matrices:
No of factors with specific components: 2 
No of non-specific components partitioned: 1 
No of factors with specific components: 2 
No of specific variance components partitioned (per component): 4 
No of specific variance and covariance components partitioned (per component): 8 
no of individuals in pedigree (m) =  44 
no of individuals with data and X codes (n) =  36 
Rank of X: 2   No of Fixed Effects: 2 
DME substep:
No of components defined =  9 
No of components estimable =  9 
Checking dyadic model equations:
QR option on dyadic model equations:
DME substep completed:
OLS-b step completed:
> 
\end{verbatim}
We see that there is now one nonspecific component, and 2 factors with specific components. The sex-specific components will have 4 classes, as above, and the tb-specific components will also have 4 classes. When we put the two specific factors together there will be $4 * 4 = 16$ classes with separate variance component estimates. The 16 classes are listed just before the end of the output tabbing above. One might caution that subdividing the component space this intensively is only meaningful with adequate sized dataset.

We should note that the effect "Tb" has also been fitted as a fixed effect. This was necessary because the column labelled "Tb" in sheep.df has an 'NA' in one of its entries. An 'NA' in the factor column for a class specific variance component is not permitted. {\em dmm()} can deal with 'NA's but these must be  removed in the fixed effect part of the model fitting. Hence it was necessary to put "Tb" in as a fixed effect to deal with the 'NA'.

Note the form of the {\em specific.components} argument of the {\em dmm(()} call. It is a list with two elements, one called Sex and one called Tb. The Sex element is a vector of length one, and the Tb element is also a vector of length one.

We will just look briefly at the variance component estimates
\begin{verbatim}
> sheep.fitssts
Call:
NULL
Fixed formula:
Ymat ~ 1 + Tb
Cohort formula:
NULL
Var/Covariance components:
NULL
Traits:
[1] "Cww"  "Diam" "Bwt" 
Fitted OLS fixed effects:
                    Cww     Diam       Bwt
(Intercept)  4.70526316 21.04211 45.894737
TbT         -0.04055728 -0.55387 -1.071207
Var/covariance components partitioned by DME after OLS fit:
                     Cww:Cww     Cww:Diam    Cww:Bwt     Diam:Cww   Diam:Diam
VarE(I)           0.38563428  0.047279595 -0.2792448  0.047279595 0.005796586
Sex:F:F:VarG(Ia)  0.06679493  0.174344832 -0.0437172  0.174344832 0.574334424
Sex:F:M:VarG(Ia)  0.10983427  0.345601540 -0.9592800  0.326608931 0.845743762
Sex:M:F:VarG(Ia)  0.10983427  0.326608931  1.4308851  0.345601540 0.845743762
Sex:M:M:VarG(Ia)  0.39858131  0.728245532  2.1704395  0.728245532 1.788165917
Tb:S:S:VarG(Ma)   0.31123428  0.491225335  3.5863191  0.491225335 1.122712602
Tb:S:T:VarG(Ma)  -0.27654192 -0.293039553  0.9256589 -0.005731901 0.807581497
Tb:T:S:VarG(Ma)  -0.27654192 -0.005731901 -2.5202994 -0.293039553 0.807581497
Tb:T:T:VarG(Ma)   0.25900257  0.387880857  1.3444133  0.387880857 0.580903673
                    Diam:Bwt    Bwt:Cww    Bwt:Diam    Bwt:Bwt
VarE(I)          -0.03423601 -0.2792448 -0.03423601  0.2022062
Sex:F:F:VarG(Ia) -0.89464807 -0.0437172 -0.89464807  5.1367992
Sex:F:M:VarG(Ia) -2.81291131  1.4308851  3.03075062 -8.4123999
Sex:M:F:VarG(Ia)  3.03075062 -0.9592800 -2.81291131 -8.4123999
Sex:M:M:VarG(Ia)  4.91211011  2.1704395  4.91211011 13.7767644
Tb:S:S:VarG(Ma)   4.45873429  3.5863191  4.45873429 45.4810063
Tb:S:T:VarG(Ma)   4.15595980 -2.5202994 -1.33583524 11.1843079
Tb:T:S:VarG(Ma)  -1.33583524  0.9256589  4.15595980 11.1843079
Tb:T:T:VarG(Ma)   2.00220129  1.3444133  2.00220129 15.3841703
Observed (residual) var/covariance after OLS fit:
           Cww      Diam       Bwt
Cww  0.2943617 0.4079038  1.506019
Diam 0.4079038 0.9742342  2.713203
Bwt  1.5060189 2.7132034 27.772355
> 
\end{verbatim}
We see there are 8 class-specific components, appropriately labelled, plus "VarE(I)". This is the brief output obtained with {\em print()} or by just naming the 'fit' object. For the full output with standard errors use {\em summary()} and/or {\em csummary()}.

We will just show the gsummary for one trait
\begin{verbatim}
> gsummary(sheep.fitssts,traitset="Cww")
Call:
gsummary.specific(dmmobj = dmmobj, traitset = traitset, componentset = componentset, 
    bytrait = bytrait, gls = gls, digits = digits)

Components partitioned by DME from residual var/covariance after OLS-b fit:


Specific class:  Sex:F:F:Tb:S:S 
Proportion of phenotypic var/covariance to each component:
         Trait Estimate StdErr CI95lo CI95hi
VarE(I)    Cww   0.5050 0.1126  0.284  0.726
VarG(Ia)   Cww   0.0875 0.1132 -0.134  0.309
VarG(Ma)   Cww   0.4076 0.0811  0.249  0.566
VarP(I)    Cww   1.0000 0.0000  1.000  1.000

Correlation corresponding to each var/covariance component:
         Traitpair Estimate StdErr CI95lo CI95hi
VarE(I)    Cww:Cww        1      0      1      1
VarG(Ia)   Cww:Cww        1      0      1      1
VarG(Ma)   Cww:Cww        1      0      1      1
VarP(I)    Cww:Cww        1      0      1      1

Phenotypic var/covariance from summing components:
  Traitpair Estimate StdErr CI95lo CI95hi
1   Cww:Cww    0.764 0.0695  0.627    0.9



Specific class:  Sex:F:F:Tb:S:T 
Proportion of phenotypic var/covariance to each component:
         Trait Estimate StdErr CI95lo CI95hi
VarE(I)    Cww       NA     NA     NA     NA
VarG(Ia)   Cww       NA     NA     NA     NA
VarG(Ma)   Cww       NA     NA     NA     NA
VarP(I)    Cww       NA      0     NA     NA

Correlation corresponding to each var/covariance component:
         Traitpair Estimate StdErr CI95lo CI95hi
VarE(I)    Cww:Cww    1.000     NA     NA     NA
VarG(Ia)   Cww:Cww    1.000      0  1.000  1.000
VarG(Ma)   Cww:Cww   -0.974      0 -0.974 -0.974
VarP(I)    Cww:Cww    1.000     NA     NA     NA

Phenotypic var/covariance from summing components:
  Traitpair Estimate StdErr CI95lo CI95hi
1   Cww:Cww       NA     NA     NA     NA


...........
and so on for all 16 classes covering all combinations of Sex and Tb
\end{verbatim}
 Note that within the output for each specific class, only the generic name of each component is used to lable output. For example in "Specific class:  Sex:F:F:Tb:S:S" the component labelled "VarG(Ia)" is really "Tb:S:S:VarG(Ia)" and the component labelled "VarG(Ma)" is really "Tb:S:S:VarG(Ma)". The user is expected to know which components were made specific to which factor. 

The component or parameter labelled "VarP(I)" will always be specific to  all factors, so for the above case it is really "Sex:F:F:Tb:S:S:VarP(I)". It does not feature significantly in the abbreviated listing above, because we omitted all the cross-trait cases by specifying only one trait.

\subsection{More than one parameter specific to a factor}
Assume that we now wish to change the analysis of the sheep.df data, so that components "VarG(Ia)" and "VarG(Ma)" are both Sex-specific.  The call to {\em dmm()} for this case is as folllows
\begin{verbatim}
> sheep.fitss2<- dmm(sheep.mdf, Ymat ~ 1 + Year + Sex,
   components=c("VarE(I)"),
   specific.components=list(Sex=c("VarG(Ia)","VarG(Ma)")))
Dyadic mixed model fit for datafile: sheep.mdf  
Data file is a normal dataframe:
Random effect partitioned into components: Residual:
OLS-b step:
no of fixed effect df (k) =  9 
no of traits (l) =  3 
Setup antemodel matrices:
No of factors with specific components: 1 
No of non-specific components partitioned: 1 
No of factors with specific components: 1 
No of specific variance components partitioned (per component): 2 
No of specific variance and covariance components partitioned (per component): 8 
no of individuals in pedigree (m) =  44 
no of individuals with data and X codes (n) =  37 
Rank of X: 9   No of Fixed Effects: 9 
DME substep:
No of components defined =  9 
No of components estimable =  9 
Checking dyadic model equations:
QR option on dyadic model equations:
DME substep completed:
OLS-b step completed:
> 
\end{verbatim}
So we see that the {\em specific.components} argument  is now a list containing a single vector element called Sex, and this vector is of length two. So it makes two components Sex-specific. We shall not list the output from the various summary functions. It should by now be obvious to the user how to do that.

\section{Limitations and features}
The way that  {\em dmm()} is set up to estimate class specific components opens the door to some new features ( compared to the usual method of defining separate classes as separate traits), but also imposes some restrictions.

The limitations first
\begin{itemize}
\item the classes within any factor used to generate class specific component estimates must be mutually exclusive. For example, an animal can only be of one Sex so the Sex classes are mutually exclusive. A factor such as Age where individuals are measured at more than one age, does not have mutually exclusive classes. So repeated measures models can not be handled for a class-specific estimation at the moment. They can, of course, be handled by making each Age class a separate trait, but that carries with it making all components Age-specific.
This will be addressed in a future release of {\em dmm()}.
\item a component can not be made specific to more than one factor simultaneously. If you really want, for example, "VarG(Ia)" to be both Sex-specific and Tb-specific, you should define a new factor combining Sex and Tb in the data frame, and use that factor. This restriction occurs because the way {\em dmm()} sets up estimation equations for a class specific component amounts to a 'cell means' model. It fits the component to each class of a factor. It can not, for example, separate a component into two main effects and an interaction. It is felt that this corresponds to what a user wants from class-specific component estimation - one component estimate for each class of the population, not a study of fixed factor effects on components.
\item a component can not be made nonspecific and class specific simultaneously. In other words a component name should not appear in both the {\em components =} and {\em specific.components =} arguments. This can lead to problems if there are no nonspecific components defined. If the {\em components = } argument is omitted it reverts to the default, which is {\em c("VarE(I)","VarG(Ia)")} and this is not what is required. The {\em components = } argument should be set to {\em components = NULL} in this case. This will cancel the default.
\item Missing values ('NA') for a factor used to make class-specific components can be a problem, if the factor is not fitted as a fixed effect. This occurs because {\em dmm()} deals with 'NA's at the fixed model fitting stage. The way around the problem is to fit the factor as a fixed effect, even if you think its fixed effect negligable.
\item If one of the cross-effect covariances (eg CovG(Ia,Ma)) are fitted and are class specific, then the corresponding variances ( ie VarG(Ia) and VarG(Ma)) must be fitted and must also be class specific to the same factor. 

 If one of the cross-effect covariances (eg CovG(Ia,Ma)) are fitted and are not class specific, then the corresponding variances ( ie VarG(Ia) and VarG(Ma)) must be fitted and must also not be class specific.

 At the moment {\em dmm} does not have the ability to find the appropriate variances for calculation of correlations from cross-effect covariances, unless these variances are also defined within the same set ( ie either the nonspecific components set, or the specific components set)
\item In {\em dmm\_2.1-2} release, any component can be made class-specific, as long as the specific factor has mutually exclusive classes. The components "VarE(I)",  "CovE(I,M)", "CovE(M,I)","CovE(I,M\&!C)", "CovE(M\&!C,I)" do not have estimable cross-class covariances, so these are excluded from the estimation process, and marked as NA.  {\em dmm()} only sets up  the within-class equations, for these components. The class specific within-class variances should be estimable, for these environmental components.

   The reason that the cross-class components are not estimable for these individual environmental components, is that the class levels are mutually exclusive, so there is no cross-class replication. When it comes to class-specific factors such as Age, where the class levels may not be mutually exclusive, then the cross-class covariances should be estimable. 
\item the function {\em gresponse()} can not at the moment handle class-specific genetic parameters. This will be addressed in a future release.
\end{itemize}
 
Now the features
\begin{itemize}
\item  it is possible to make only some of the components class specific, and to leave others as an overall estimate. See the first example in Section~\ref{sec:getstart}
\item  it is possible to make some components specific to one factor, and other components specific to another factor, and others nonspecific, all in the one model fit. See the second example in Section~\ref{sec:getstart}.
\item it is possible to make more than one component specific to a single factor. See the third example in Section~\ref{sec:getstart}.
\item  the factor(s) to which some components are class-specific can also be fitted as fixed effect(s) if one wishes, but they do not have to be. However see note above concerning 'NA's.
\item the regrouping of variance components into specific classes, which occurrs after estimation and before their use in calculating genetic parameters, will occur whenever at least one component is class-specific. It is done to ensure components within each class sum to an appropriate phenotypic variance. 
\item when one or more components are not class specific, the global estimate(s) is(are) used within each class, and the cross-class covariances for nonspecific component(s) are set to NA. This is what one is asserting in not making a component class specific - that it is the same for all classes. The cross-class covariances for non-specific component(s) should probably be set equal to the global variance estimate, so that the cross-class correlation becomes unity.
\item when all components are not class specific, variance components are not regrouped into classes, and the output is the same as {\em dmm\_1.7-1}.
\end{itemize}

\section{Labelling of variance components}
	There are a number  of different types of variance and covariance components. We make the following distinctions
\begin{itemize}
\item single-trait versus cross-trait
\item single-effect versus cross-effect
\item nonspecific versus within-class versus cross-class
\item all combinations of the above, for example single-trait-cross-class,...
\end{itemize}
The only ones of the above which are variances are single-trait, single-effect, and (nonspecific or within-class), and their combinations. However {\em dmm()} does not follow this convention, but instead labels everhthing as "Var" , unless it is a cross-class covariance ( which it calls "Cov"). So cross-trait covariances come out as "Var", and cross-class covariances come out as "Var".

For genetic parameters {\em dmm()} uses the same labels as the corresponding variance or covariance component. 

It is hoped that this approach does not lead to confusion. The labels are derived from the component names used in the {\em components=} and {\em specific.components=} arguments of the call to {\em dmm()}. The component names used in these arguments must chosen from the list of standard component names defined by the {\em make.ctable()} function. The labels are used to control program flow, as well as to label output so their form has to be strictly controlled.

For each component, {\em dmm()} keeps both a short-component-name and a long-component-name.
The short-component-name is the generic name as defined in {\em make.ctable()}. The long-component-name has the class information prepended, if the component is class-specific. In functions {\em csummary()} and {\em gsummary()} only the short-component-names are used as line labels, and the class information appears at the head of each table. The user should know, in this context, which componentsa are class specific. In the output of the {\em print()} and {\em summary()} functions the long-component-names are used as line-labels.


\section{A dataset with 'known' results}
The {\em warcolak} dataset, developed by Dr Matthew Wolak, and included with his package {\em nadiv} is a valuable testbed for both sex-linked and sex-specific variance components.
 
There is an analysis of this dataset without fitting sex-specific variance components in the {\em dmmOverview.pdf} document. Here we report the extension of those analyses to include sex-specific components.

We do an analysis of both traits simultaneously
\begin{verbatim}
> library(dmm)
> data(warcolak)
> warcolak.df <- warcolal.convert(warcolak)
> warcolak.mdf <- warcolak.df,pedcols=c(1:3),factorcols=4,
    ycols=c(5:6),sexcode=c("M","F"),relmat=c("E","A","D","S"),keep=T)
  .....
> warcolak.fitsp <- dmm(warcolak.mdf,Ymat ~ 1 + Sex,
    components=c("VarE(I)"),
    specific.components=list(Sex=c("VarG(Ia)","VarG(Id)","VarGs(Ia)")),
    relmat="withdf")
Dyadic mixed model fit for datafile: warcolak.mdf  
Data file is a list containing a dataframe and a list of relationship matrices:
Random effect partitioned into components: Residual:
OLS-b step:
no of fixed effect df (k) =  2 
no of traits (l) =  2 
Setup antemodel matrices:
No of non-specific components partitioned: 1 
No of factors with specific components: 1 
No of specific variance components partitioned: 2 
No of specific variance and covariance components partitioned: 12 
no of individuals in pedigree (m) =  5400 
no of individuals with data and X codes (n) =  5400 
Rank of X: 2   No of Fixed Effects: 2 
DME substep:
>
> warcolak.fitsp
Call:
dmm.default(mdf = warcolak.mdf, fixform = Ymat ~ 1 + Sex, components = c("VarE(I)"), 
    specific.components = list(Sex = c("VarG(Ia)", "VarG(Id)", 
        "VarGs(Ia)")), relmat = "withdf")
Fixed formula:
Ymat ~ 1 + Sex
Cohort formula:
NULL
Var/Covariance components:
NULL
Traits:
[1] "Trait1" "Trait2"
Fitted OLS fixed effects:
               Trait1    Trait2
(Intercept)  2.064586  1.987414
SexM        -1.020755 -1.003316
Var/covariance components partitioned by DME after OLS fit:
                  Trait1:Trait1 Trait1:Trait2 Trait2:Trait1 Trait2:Trait2
VarE(I)             0.323035677  0.0863747023  0.0863747023   0.279919826
Sex:F:F:VarG(Ia)    0.251920865 -0.0433274504 -0.0433274504   0.335856856
Sex:F:M:VarG(Ia)    0.322903346  0.0533128036  0.0572557684   0.276175076
Sex:M:F:VarG(Ia)    0.322903346  0.0572557684  0.0533128035   0.276175076
Sex:M:M:VarG(Ia)    0.413886206  0.0646480722  0.0646480722   0.280318258
Sex:F:F:VarG(Id)    0.298195437 -0.1124049761 -0.1124049761   0.326987507
Sex:F:M:VarG(Id)    0.266975697 -0.1577731528 -0.1332074242   0.351402955
Sex:M:F:VarG(Id)    0.266975697 -0.1332074242 -0.1577731528   0.351402955
Sex:M:M:VarG(Id)    0.239024525 -0.1116635575 -0.1116635575   0.413470726
Sex:F:F:VarGs(Ia)   0.100468892  0.0539144400  0.0539144400   0.046900097
Sex:F:M:VarGs(Ia)  -0.006281569 -0.0177546729 -0.0004747249   0.012130641
Sex:M:F:VarGs(Ia)  -0.006281569 -0.0004747249 -0.0177546729   0.012130641
Sex:M:M:VarGs(Ia)   0.005980401 -0.0043317363 -0.0043317363   0.003137572
Observed (residual) var/covariance after OLS fit:
             Trait1       Trait2
Trait1  0.966773859 -0.003685244
Trait2 -0.003685244  0.966581259
> 
\end{verbatim}
The brief varaince component output looks reasonable. It is a little easier to see what we are getting if we reorganise the component estimates into classes
\begin{verbatim}
> csummary(warcolak.fitsp)
Call:
csummary.specific(object = object, traitset = traitset, componentset = componentset, 
    bytrait = bytrait, gls = gls, digits = digits)

Components partitioned by DME from residual var/covariance after OLS-b fit:


Specific class:  Sex:F:F 
              Traitpair Estimate StdErr CI95lo CI95hi
VarE(I)   Trait1:Trait1    0.323 0.0542 0.2168  0.429
VarG(Ia)  Trait1:Trait1    0.252 0.0511 0.1519  0.352
VarG(Id)  Trait1:Trait1    0.298 0.0570 0.1865  0.410
VarGs(Ia) Trait1:Trait1    0.100 0.0366 0.0287  0.172
VarP(I)   Trait1:Trait1    0.974 0.0174 0.9395  1.008

              Traitpair Estimate StdErr  CI95lo   CI95hi
VarE(I)   Trait1:Trait2   0.0864 0.0542 -0.0198  0.19259
VarG(Ia)  Trait1:Trait2  -0.0433 0.0511 -0.1434  0.05674
VarG(Id)  Trait1:Trait2  -0.1124 0.0570 -0.2241 -0.00075
VarGs(Ia) Trait1:Trait2   0.0539 0.0366 -0.0179  0.12571
VarP(I)   Trait1:Trait2  -0.0154 0.0174 -0.0496  0.01870

              Traitpair Estimate StdErr  CI95lo   CI95hi
VarE(I)   Trait2:Trait1   0.0864 0.0542 -0.0198  0.19259
VarG(Ia)  Trait2:Trait1  -0.0433 0.0511 -0.1434  0.05674
VarG(Id)  Trait2:Trait1  -0.1124 0.0570 -0.2241 -0.00075
VarGs(Ia) Trait2:Trait1   0.0539 0.0366 -0.0179  0.12571
VarP(I)   Trait2:Trait1  -0.0154 0.0174 -0.0496  0.01870

              Traitpair Estimate StdErr  CI95lo CI95hi
VarE(I)   Trait2:Trait2   0.2799 0.0542  0.1737  0.386
VarG(Ia)  Trait2:Trait2   0.3359 0.0510  0.2358  0.436
VarG(Id)  Trait2:Trait2   0.3270 0.0570  0.2154  0.439
VarGs(Ia) Trait2:Trait2   0.0469 0.0366 -0.0249  0.119
VarP(I)   Trait2:Trait2   0.9897 0.0174  0.9555  1.024



Specific class:  Sex:F:M 
              Traitpair Estimate StdErr  CI95lo CI95hi
VarE(I)   Trait1:Trait1       NA     NA      NA     NA
VarG(Ia)  Trait1:Trait1  0.32290 0.0282  0.2676 0.3782
VarG(Id)  Trait1:Trait1  0.26698 0.0691  0.1315 0.4025
VarGs(Ia) Trait1:Trait1 -0.00628 0.0322 -0.0694 0.0568
VarP(I)   Trait1:Trait1       NA     NA      NA     NA

              Traitpair Estimate StdErr  CI95lo  CI95hi
VarE(I)   Trait1:Trait2       NA     NA      NA      NA
VarG(Ia)  Trait1:Trait2   0.0533 0.0282 -0.0020  0.1086
VarG(Id)  Trait1:Trait2  -0.1578 0.0691 -0.2933 -0.0223
VarGs(Ia) Trait1:Trait2  -0.0178 0.0322 -0.0809  0.0453
VarP(I)   Trait1:Trait2       NA     NA      NA      NA

              Traitpair  Estimate StdErr   CI95lo CI95hi
VarE(I)   Trait2:Trait1        NA     NA       NA     NA
VarG(Ia)  Trait2:Trait1  0.057256 0.0282  0.00194 0.1126
VarG(Id)  Trait2:Trait1 -0.133207 0.0691 -0.26872 0.0023
VarGs(Ia) Trait2:Trait1 -0.000475 0.0322 -0.06357 0.0626
VarP(I)   Trait2:Trait1        NA     NA       NA     NA

              Traitpair Estimate StdErr CI95lo CI95hi
VarE(I)   Trait2:Trait2       NA     NA     NA     NA
VarG(Ia)  Trait2:Trait2   0.2762 0.0282  0.221 0.3315
VarG(Id)  Trait2:Trait2   0.3514 0.0691  0.216 0.4869
VarGs(Ia) Trait2:Trait2   0.0121 0.0322 -0.051 0.0752
VarP(I)   Trait2:Trait2       NA     NA     NA     NA



Specific class:  Sex:M:F 
              Traitpair Estimate StdErr  CI95lo CI95hi
VarE(I)   Trait1:Trait1       NA     NA      NA     NA
VarG(Ia)  Trait1:Trait1  0.32290 0.0282  0.2676 0.3782
VarG(Id)  Trait1:Trait1  0.26698 0.0691  0.1315 0.4025
VarGs(Ia) Trait1:Trait1 -0.00628 0.0322 -0.0694 0.0568
VarP(I)   Trait1:Trait1       NA     NA      NA     NA

              Traitpair  Estimate StdErr   CI95lo CI95hi
VarE(I)   Trait1:Trait2        NA     NA       NA     NA
VarG(Ia)  Trait1:Trait2  0.057256 0.0282  0.00194 0.1126
VarG(Id)  Trait1:Trait2 -0.133207 0.0691 -0.26872 0.0023
VarGs(Ia) Trait1:Trait2 -0.000475 0.0322 -0.06357 0.0626
VarP(I)   Trait1:Trait2        NA     NA       NA     NA

              Traitpair Estimate StdErr  CI95lo  CI95hi
VarE(I)   Trait2:Trait1       NA     NA      NA      NA
VarG(Ia)  Trait2:Trait1   0.0533 0.0282 -0.0020  0.1086
VarG(Id)  Trait2:Trait1  -0.1578 0.0691 -0.2933 -0.0223
VarGs(Ia) Trait2:Trait1  -0.0178 0.0322 -0.0809  0.0453
VarP(I)   Trait2:Trait1       NA     NA      NA      NA

              Traitpair Estimate StdErr CI95lo CI95hi
VarE(I)   Trait2:Trait2       NA     NA     NA     NA
VarG(Ia)  Trait2:Trait2   0.2762 0.0282  0.221 0.3315
VarG(Id)  Trait2:Trait2   0.3514 0.0691  0.216 0.4869
VarGs(Ia) Trait2:Trait2   0.0121 0.0322 -0.051 0.0752
VarP(I)   Trait2:Trait2       NA     NA     NA     NA



Specific class:  Sex:M:M 
              Traitpair Estimate StdErr  CI95lo CI95hi
VarE(I)   Trait1:Trait1  0.32304 0.0542  0.2168 0.4292
VarG(Ia)  Trait1:Trait1  0.41389 0.0198  0.3750 0.4528
VarG(Id)  Trait1:Trait1  0.23902 0.0648  0.1120 0.3660
VarGs(Ia) Trait1:Trait1  0.00598 0.0463 -0.0848 0.0968
VarP(I)   Trait1:Trait1  0.98193 0.0297  0.9236 1.0402

              Traitpair Estimate StdErr  CI95lo CI95hi
VarE(I)   Trait1:Trait2  0.08637 0.0542 -0.0198 0.1926
VarG(Ia)  Trait1:Trait2  0.06465 0.0198  0.0257 0.1036
VarG(Id)  Trait1:Trait2 -0.11166 0.0648 -0.2387 0.0153
VarGs(Ia) Trait1:Trait2 -0.00433 0.0463 -0.0951 0.0865
VarP(I)   Trait1:Trait2  0.03503 0.0297 -0.0233 0.0933

              Traitpair Estimate StdErr  CI95lo CI95hi
VarE(I)   Trait2:Trait1  0.08637 0.0542 -0.0198 0.1926
VarG(Ia)  Trait2:Trait1  0.06465 0.0198  0.0257 0.1036
VarG(Id)  Trait2:Trait1 -0.11166 0.0648 -0.2387 0.0153
VarGs(Ia) Trait2:Trait1 -0.00433 0.0463 -0.0951 0.0865
VarP(I)   Trait2:Trait1  0.03503 0.0297 -0.0233 0.0933

              Traitpair Estimate StdErr  CI95lo CI95hi
VarE(I)   Trait2:Trait2  0.27992 0.0542  0.1737 0.3861
VarG(Ia)  Trait2:Trait2  0.28032 0.0198  0.2414 0.3192
VarG(Id)  Trait2:Trait2  0.41347 0.0648  0.2865 0.5404
VarGs(Ia) Trait2:Trait2  0.00314 0.0463 -0.0876 0.0939
VarP(I)   Trait2:Trait2  0.97685 0.0297  0.9186 1.0351

> 
\end{verbatim}
The estimated components "VarE(I)", "VarG(Ia)", "VarG(Id)", and "VarGs(Ia)" should agree with the stated population values (0.3,0.4,0.3,0.0) for Trait1 and (0.3,0.3,0.3,0.1) for Trait2 respectively.  Because we know from the simulation of the warcolak dataset that the genetic effects do not differ between the sexes, we should expect to see both the male and female component estimates agree with the above population values, within the limits of sampling errors. We expect the cross-sex-single-trait estimates of covariances to also agree with te above population values, and we expect the cross-trait-within-sex and cross-trait-cross-sex components to all be close to zero.

These expectations are  more or less fulfilled. The component "VarGs(Ia)" is a bit large for Trait1 in females, but is OK for males. The component "VarG(Ia)" is a bit small for Trait1 in females, but again is OK for males. The cross-sex-single-trait components are OK for "VarG(Ia)" and "VarG(Id)", but are close to zero for "VarGs(Ia)". The "VarGs(Ia)" estimates are smaller than they should be for Trait2 especially in males.

The warcolak dataset is not ideal for testing sex-specific component estimation, because it has no sex-difference in parameters. We correctly get the expected zero difference result, but an actual difference to check against would be desirable.


\section{Calculating genetic change}
The function {\em gresponse()} has not yet ( as of dmm\_2.1-1) been updated to deal with class-specific parameter estimates. It is expected that this will be fixed in a future release.


\section{The structure of an object of {\em class dmm} when some components are class-specific}
A {\em dmm object} for a totally nonspecific analysis looks as follows
\begin{verbatim}
> names(sheep.fitm2)
 [1] "aov"                    "mdf"                    "fixform"               
 [4] "b"                      "seb"                    "vara"                  
 [7] "totn"                   "degf"                   "dme.mean"              
[10] "dme.var"                "dme.correl"             "dmeopt"                
[13] "siga"                   "sesiga"                 "vard"                  
[16] "degfd"                  "component"              "correlation"           
[19] "correlation.variance"   "correlation.se"         "fraction"              
[22] "fraction.variance"      "fraction.se"            "variance.components"   
[25] "variance.components.se" "phenotypic.variance"    "phenotypic.variance.se"
[28] "observed.variance" 
\end{verbatim}
All of the named items above apply to the whole population, and are as defined on the {\em dmm()} help page.

A {\em dmm object} for a case where some components are class specific looks as follows
\begin{verbatim}
> names(warcolak.fitsp)
 [1] "aov"        "mdf"        "fixform"    "b"          "seb"       
 [6] "vara"       "totn"       "degf"       "dme.mean"   "dme.var"   
[11] "dme.correl" "dmeopt"     "siga"       "sesiga"     "vard"      
[16] "degfd"      "specific"   "call"  
\end{verbatim}
Some of the items have 'disappeared' and they will be found inside the new item called 'specific' as follows
\begin{verbatim}
> names(warcolak.fitsp$specific)
[1] "Sex:F:F" "Sex:F:M" "Sex:M:F" "Sex:M:M"

> names(warcolak.fitsp$specific[["Sex:F:F"]])
 [1] "component"              "phencovclass"           "component.longnames"   
 [4] "correlation"            "correlation.variance"   "correlation.se"        
 [7] "fraction"               "fraction.variance"      "fraction.se"           
[10] "variance.components"    "variance.components.se" "phenotypic.variance"   
[13] "phenotypic.variance.se" "observed.variance"     
> 
> names(warcolak.fitsp$specific[["Sex:F:M"]])
 .....
>
\end{verbatim}
 So within 'warcolak.fitsp\$specific' there are 4 items labelled with the class names for the "Sex" effect, and within each of those class name items are the 
estimates for that class. So the 'disappeared' items have been moved down 2 levels, because they are all the estimates that become class-specific. What remains at the top level are the parameters which are not class-specific. 

If the option {\em gls=T} is used, there is an item 'gls' and the whole structure is repeated within that item.

The user does not have to use the supplied functions ({\em summary, csummary, gsummary)} to access a {\em dmm object}. The usual R functions for lists can be used.



\begin{thebibliography}{99}

\bibitem{jack:15}
Jackson, N. (2015) An Overview of the R package dmm.
    From http://cran.r-project.org/package=dmm 
    Or https://github.com/cran/dmm

\bibitem{sear:92}
Searle, S.R., Casella, G., and McCullock, C.E. (1992) Variance Components.
    John Wiley and Sons, New York.

\bibitem{wola:14}
Wolak, M.E. (2014) nadiv: an R package to create relatedness matrices for
    estimating non-additive genetic variances in animal models.
    Methods in Ecology and Evolution 3:792-796.
\end{thebibliography}
\end{document}
